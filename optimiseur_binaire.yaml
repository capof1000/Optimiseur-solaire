blueprint:
  name: Pilotage chauffe-eau sur surplus photovoltaÃ¯que
  description: >
    Allume ou Ã©teint un chauffe-eau Ã©lectrique en fonction du surplus PV.
    Le surplus est mesurÃ© par une entitÃ© (positive = export, nÃ©gative = import).
    Le chauffe-eau est contrÃ´lÃ© en ON/OFF via un switch ou relais.
  domain: automation
  input:
    surplus_sensor:
      name: Capteur de surplus PV
      description: >
        EntitÃ© reprÃ©sentant le surplus (W).
        Exemple : sensor.surplus_pv ou sensor.linky_papp calculÃ©.
      selector:
        entity:
          domain: sensor

    water_heater_switch:
      name: Commutateur du chauffe-eau
      selector:
        entity:
          domain: switch

    min_surplus:
      name: Seuil minimum de surplus pour allumer (W)
      default: 500
      selector:
        number:
          min: 0
          max: 5000
          step: 50
          unit_of_measurement: W

    min_duration:
      name: Surplus minimum stable pendant (minutes)
      description: >
        DurÃ©e pendant laquelle le surplus doit rester au-dessus du seuil
        avant d'allumer le chauffe-eau.
      default: 3
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: min

    off_delay:
      name: DurÃ©e avant extinction si plus de surplus (minutes)
      default: 5
      selector:
        number:
          min: 1
          max: 60
          step: 1
          unit_of_measurement: min

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input surplus_sensor

variables:
  surplus_entity: !input surplus_sensor
  seuil: !input min_surplus

condition: []

action:
  - choose:
      # ðŸ”¹ Condition pour ALLUMER
      - conditions:
          - condition: numeric_state
            entity_id: !input surplus_sensor
            above: !input min_surplus
          - condition: state
            entity_id: !input water_heater_switch
            state: "off"
          - condition: template
            value_template: >
              {{ (now() - states[surplus_entity].last_changed).total_seconds() > (60 * (min_duration | int)) }}
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input water_heater_switch

      # ðŸ”¹ Condition pour Ã‰TEINDRE
      - conditions:
          - condition: numeric_state
            entity_id: !input surplus_sensor
            below: 0
          - condition: state
            entity_id: !input water_heater_switch
            state: "on"
          - condition: template
            value_template: >
              {{ (now() - states[surplus_entity].last_changed).total_seconds() > (60 * (off_delay | int)) }}
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input water_heater_switch

