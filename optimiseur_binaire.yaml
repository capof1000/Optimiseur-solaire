blueprint:
  name: Optimisation consommation √©lectrique (surplus)
  description: >
    Allume un √©quipement quand la consommation nette du foyer devient n√©gative
    et l'√©teint lorsque la consommation nette d√©passe la consommation de l'√©quipement.
  domain: automation
  input:
    net_consumption:
      name: Consommation nette du foyer (W)
      description: Capteur indiquant la consommation nette (n√©gatif = surplus)
      selector:
        entity:
          domain: sensor
          device_class: power

    equipment_switch:
      name: √âquipement √† contr√¥ler
      description: Input_boolean ou switch qui commande l‚Äô√©quipement
      selector:
        entity:
          domain: 
            - switch
            - input_boolean

    equipment_power:
      name: Puissance consomm√©e par l‚Äô√©quipement (W)
      description: Capteur powercalc repr√©sentant la consommation de l'appareil
      selector:
        entity:
          domain: sensor
          device_class: power

mode: restart

trigger:
  - platform: state
    entity_id: !input net_consumption
  - platform: state
    entity_id: !input equipment_power

condition: []

action:
  - choose:

      # üîµ SURPRODUCTION : consommation nette < 0 ‚Üí ON
      - conditions:
          - condition: numeric_state
            entity_id: !input net_consumption
            below: 0
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: !input equipment_switch

      # üî¥ CONSOMMATION NETTE > CONSO APPAREIL ‚Üí OFF
      - conditions:
          - condition: template
            value_template: >
              {{ states( !input net_consumption ) | float >
                 states( !input equipment_power ) | float }}
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input equipment_switch

