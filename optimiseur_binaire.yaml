blueprint:
  name: Optimisateur d'auto-consommation
  description: Automation g√©n√©rique pour allumer/√©teindre lorsque la consommation nette devient n√©gative avec gestion d'offset
  domain: automation

  input:
    net_consumption:
      name: Consommation nette (W)
      selector:
        entity:
          domain: sensor
          device_class: power

    equipment_switch:
      name: √âquipement √† contr√¥ler
      selector:
        entity:
          domain:
            - switch
            - input_boolean

    equipment_power:
      name: Puissance consomm√©e par l‚Äô√©quipement (W)
      selector:
        entity:
          domain: sensor
          device_class: power

    delay_off:
      name: D√©lai OFF (secondes)
      description: Temps que la consommation nette doit rester sup√©rieure √† l'√©quipement pour √©teindre
      default: 120
      selector:
        number:
          min: 0
          max: 3600
          step: 1
          unit_of_measurement: "s"

    offset:
      name: Offset √† l'allumage (W)
      description: Consommation nette inf√©rieure √† cette valeur pour allumer l'√©quipement (valeur n√©gative)
      default: 0
      selector:
        number:
          min: -1000
          max: 0
          step: 1
          unit_of_measurement: "W"

mode: restart

trigger:
  # Surproduction ‚Üí ON imm√©diat si consommation nette inf√©rieure ou √©gale √† l'offset
  - platform: numeric_state
    entity_id: !input net_consumption
    below: !input offset
    id: surplus_on

  # Consommation > √©quipement ‚Üí OFF apr√®s d√©lai param√©trable
  - platform: numeric_state
    entity_id: !input net_consumption
    above: !input equipment_power
    for:
      seconds: !input delay_off
    id: excess_off

variables:
  net_entity: !input net_consumption
  equip_entity: !input equipment_power
  switch_entity: !input equipment_switch
  delay_off_sec: !input delay_off
  offset_value: !input offset

condition: []

action:
  - choose:

      # üîµ Allumer l'√©quipement si surproduction et consommation nette inf√©rieure ou √©gale √† l'offset
      - conditions:
          - condition: trigger
            id: surplus_on
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: "{{ switch_entity }}"

      # üî¥ √âteindre si consommation nette > √©quipement et d√©lai OFF
      - conditions:
          - condition: trigger
            id: excess_off
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ switch_entity }}"
