blueprint:
  name: Optimisation consommation √©lectrique (surplus) avec hyst√©r√©sis et d√©lai OFF
  description: Automation g√©n√©rique pour allumer/√©teindre un √©quipement selon surplus PV, avec hyst√©r√©sis et d√©lai OFF bas√© sur la consommation
  domain: automation

  input:
    net_consumption:
      name: Consommation nette (W)
      selector:
        entity:
          domain: sensor
          device_class: power

    equipment_switch:
      name: √âquipement √† contr√¥ler
      selector:
        entity:
          domain:
            - switch
            - input_boolean

    equipment_power:
      name: Puissance consomm√©e par l‚Äô√©quipement (W)
      selector:
        entity:
          domain: sensor
          device_class: power

    hysteresis:
      name: Hyst√©r√©sis (W)
      description: Marge pour √©viter les allumages/extinctions trop rapides
      default: 50
      selector:
        number:
          min: 0
          max: 500
          step: 10
          unit_of_measurement: "W"

    delay_off:
      name: D√©lai OFF (secondes)
      description: Temps que la consommation nette doit rester sup√©rieure √† l'√©quipement pour √©teindre
      default: 5
      selector:
        number:
          min: 0
          max: 600
          step: 1
          unit_of_measurement: "s"

mode: restart

trigger:
  # Surproduction ‚Üí ON imm√©diat
  - platform: numeric_state
    entity_id: !input net_consumption
    below: 0
    id: surplus_on

  # Consommation > √©quipement ‚Üí OFF apr√®s d√©lai param√©trable
  - platform: numeric_state
    entity_id: !input net_consumption
    above: !input equipment_power
    for:
      seconds: !input delay_off
    id: excess_off

variables:
  net_entity: !input net_consumption
  equip_entity: !input equipment_power
  switch_entity: !input equipment_switch
  hyst: !input hysteresis
  delay_off_sec: !input delay_off

condition: []

action:
  - choose:

      # üîµ Allumer l'√©quipement si surproduction + hyst√©r√©sis
      - conditions:
          - condition: trigger
            id: surplus_on
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: "{{ switch_entity }}"

      # üî¥ √âteindre si consommation nette > √©quipement + hyst√©r√©sis et d√©lai OFF
      - conditions:
          - condition: trigger
            id: excess_off
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ switch_entity }}"
